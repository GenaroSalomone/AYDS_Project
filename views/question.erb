<!-- question.erb -->
<!DOCTYPE html>
<html>
<head>
  <title>Pregunta</title>
  <link rel="stylesheet" type="text/css" href="/css/question.css">
  <!-- Importación de librería JS para implementar el temporizador -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Código JavaScript para manejar la validación de la selección de respuesta -->
  <script>
    function validateForm() {
      var selectedOption = document.querySelector('input[name="selected_answer"]:checked');
      var timeRemaining = parseInt($('#timer').text());

      if (!selectedOption && timeRemaining > 0) {
        // Si no se seleccionó ninguna opción y todavía hay tiempo restante, mostrar mensaje de alerta
        alert("Debe seleccionar una respuesta antes de continuar.");
        return false;
      }
      // Si se cumple la validación existente, se asigna selected_answer como null
      if (!selectedOption) {
        document.querySelector('input[name="selected_answer"]').value = null;
      }
      return true;
    }

    function autocompleteValidateForm() {
      var autocompleteInput = document.getElementById('autocomplete-input');
      var timeRemaining = parseInt($('#timer').text());

      if (autocompleteInput.value.trim().length === 0 && timeRemaining > 0) {
        // Si no se ha ingresado ningún carácter y todavía hay tiempo restante, mostrar mensaje de alerta
        alert("Debe ingresar al menos un carácter antes de continuar.");
        return false;
      }

      return true;
    }
  </script>
</head>
<body>
  <h1>Pregunta <%= @question_index + 1 %> :</h1>
  <% if @question %>
    <p><%= @question.text %></p> <!-- Se muestra la pregunta -->
    <% if @question.is_a?(Autocomplete) %>
      <h2>Ingrese su respuesta:</h2>
      <form action="/answer" method="post" onsubmit="return autocompleteValidateForm()">
        <input type="hidden" name="trivia_id" value="<%= @trivia.id %>">
        <input type="hidden" name="question_index" value="<%= @question_index %>">
        <div class="q-autocomplete-container">
          <input type="text" id="autocomplete-input" name="autocomplete_input" class="q-autocomplete-input">
        </div>
        <div id="timer-container" data-time-limit-seconds="<%= @time_limit_seconds %>">
          <span id="timer"></span>
        </div>
        <div class="button-container">
          <button type="submit">Siguiente pregunta</button>
        </div>
      </form>
    <% else %>
      <h2>Opciones:</h2>
      <form action="/answer" method="post" onsubmit="return validateForm()">
        <input type="hidden" name="trivia_id" value="<%= @trivia.id %>">
        <input type="hidden" name="question_index" value="<%= @question_index %>">
        <% @answers.each do |answer| %>
          <label>
            <div class="answer-container">
              <input type="radio" name="selected_answer" value="<%= answer.id %>"
                <% if answer.id == @selected_answer %>
                  checked
                <% end %>
              >
              <span class="answer-text"><%= answer.text %></span>
            </div>
          </label>
        <% end %>
        <div id="timer-container" data-time-limit-seconds="<%= @time_limit_seconds %>">
          <span id="timer"></span>
        </div>
        <div class="button-container">
          <button type="submit">Siguiente pregunta</button>
        </div>
      </form>
    <% end %>

    <div id="message-container"></div>
    <script>
      // Función para mostrar el mensaje de tiempo agotado
      function showTimeUpMessage() {
        var overlay = document.createElement("div");
        overlay.classList.add("overlay");

        var messageContainer = document.createElement("div");
        messageContainer.classList.add("message-container");
        messageContainer.innerHTML = `
          <div class="message-box">
            <p>Se terminó el tiempo, respuesta marcada como incorrecta!</p>
            <button id="entendido-btn" class="button-style">Entendido</button>
          </div>
        `;
        overlay.appendChild(messageContainer);
        document.body.appendChild(overlay);

        // Asignar el evento click al botón "Entendido"
        var entendidoBtn = document.getElementById("entendido-btn");
        entendidoBtn.addEventListener("click", function() {
          //document.querySelector('input[name="selected_answer"]').value = null; // Establecer selected_answer como null
          document.querySelector('form').submit(); // Enviar el formulario para avanzar a la siguiente pregunta
        });
      }

      // Función para avanzar a la siguiente pregunta
      function nextQuestion() {
        document.querySelector('form').submit();
      }

      // Función para iniciar el temporizador
      function startTimer(duration, display) {
        var timerContainer = document.getElementById("timer-container"); 
        var timer = duration, seconds;
        var triviaDifficultyLevel = "<%= @trivia.difficulty.level%>";
        timerContainer.className = "green"; // nombre de la clase que se asigna en timerContainer
        var intervalId = setInterval(function () {
          seconds = parseInt(timer % 60, 10);
          display.text(seconds);
          // Teniendo en cuenta la dificultad y tiempo transcurrido, el cronometro cambia de color
          timer --;
          if (triviaDifficultyLevel == "beginner") {
            if (timer <= 15 && timer >= 10){
              timerContainer.className = "green";
            } else if (timer < 10 && timer >= 5){
              timerContainer.className = "yellow";
            } else if (timer < 5 && timer >= 1){
              timerContainer.className = "red";
            } else if (timer < 0){
              clearInterval(intervalId);
              showTimeUpMessage();
            }
          } else if (triviaDifficultyLevel == "difficult") {
              if (timer <= 10 && timer >= 7){
                timerContainer.className = "green";
              } else if (timer < 7 && timer >= 4){
                timerContainer.className = "yellow";
              } else if (timer < 4 && timer >= 1){
                timerContainer.className = "red";
              } else if (timer < 0){
                clearInterval(intervalId);
                showTimeUpMessage();
              }  
          }  
        }, 1000);
      }

      // Obtener el límite de tiempo en segundos desde el atributo data del elemento #timer-container
      var timeLimitSeconds = parseInt($('#timer-container').data('time-limit-seconds'));

      // Iniciar el temporizador
      $(document).ready(function () {
        startTimer(timeLimitSeconds, $('#timer'));
      });
    </script>

  <% else %>
    <p>No hay pregunta disponible.</p>
  <% end %>
</body>
</html>
